{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Repair Request Management</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

<style>
  body {
    height: 100vh;
    font-family: 'Segoe UI', sans-serif;
    background-color: #f8f9fa;
    overflow-x: hidden;
    animation: bodyFadeSlide 0.6s ease-in-out;
  }

  @keyframes bodyFadeSlide {
    0% {
      opacity: 0;
      transform: translateY(10px);
    }
    100% {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .btn-animate {
    transition: all 0.3s ease;
  }

  .btn-animate:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
  }

  .table th, .table td {
    vertical-align: middle;
  }

  .table-responsive {
    flex: 1 0 auto;
  }

  .mt-auto {
    margin-top: auto;
  }

</style>
</head>
<body class="d-flex flex-column min-vh-100">
{% include 'repair/header.html' %}
    <div aria-live="polite" aria-atomic="true" class="position-fixed top-0 end-0 p-3" style="z-index: 1080;">
      {% if messages %}
        {% for message in messages %}
          <div class="toast align-items-center text-bg-{{ message.tags|default:"info" }} border-0 mb-2 show" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
              <div class="toast-body">
                {{ message }}
              </div>
              <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
          </div>
        {% endfor %}
      {% endif %}
    </div>

    <div class="container-fluid d-flex flex-column min-vh-100 mt-2">
    {% block content %}
      <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3 mt-0">

        <!-- Left: Action Buttons -->
        <div class="d-flex gap-2 flex-wrap">
          <a href="{% url 'add_repair' %}" class="btn btn-primary btn-animate">
            <i class="bi bi-wrench-adjustable-circle-fill me-1"></i> Add Repair Request
          </a>
          <a href="{% url 'export_csv' %}" class="btn btn-outline-primary btn-animate">
            <i class="bi bi-filetype-csv me-1"></i> Export CSV
          </a>
          <a href="{% url 'export_pdf' %}" class="btn btn-outline-danger btn-animate">
            <i class="bi bi-filetype-pdf me-1"></i> Export PDF
          </a>
        </div>

        <!-- Right: Search Bar -->
        <form method="get" class="input-group" style="max-width: 450px;">
          <input type="text" name="search" class="form-control"
                 placeholder="Search by Customer, Device or Status"
                 value="{{ request.GET.search|default_if_none:'' }}" autocomplete="off">
          <button type="submit" class="btn btn-outline-secondary">Search</button>
          <a href="{% url 'home' %}" class="btn btn-outline-dark">Reset</a>
        </form>

      </div>

      <!-- Table -->
      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead class="table-dark">
            <tr>
              <th>Customer</th>
              <th>Device</th>
              <th>Issue</th>
              <th>Repair Name</th>
              <th>Charge (₹)</th>
              <th>Bonus</th>
              <th>Technician</th>
              <th>Status</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for r in repairs %}
            <tr>
              <td>{{ r.customer.name }}</td>
              <td>{{ r.device_model }}</td>
              <td>{{ r.issue_description }}</td>
              <td>{{ r.repair_name }}</td>
              <td>₹{{ r.charge }}</td>
              <td>{{ r.bonus }}</td>
              <td>
                {% if r.technician %}
                  {{ r.technician.name }}
                {% else %}
                  <span class="text-muted">Not Assigned</span>
                {% endif %}
              </td>
              <td>
                {% if r.status == 'pending' %}
                  <span class="badge bg-warning text-dark px-3 py-2">{{ r.get_status_display|title }}</span>
                {% elif r.status == 'in_progress' %}
                  <span class="badge bg-primary px-3 py-2">{{ r.get_status_display|title }}</span>
                {% elif r.status == 'completed' %}
                  <span class="badge bg-success px-3 py-2">{{ r.get_status_display|title }}</span>
                {% elif r.status == 'rejected' %}
                  <span class="badge bg-danger px-3 py-2">{{ r.get_status_display|title }}</span>
                {% endif %}
              </td>
              <td>{{ r.date_received|date:"d M Y" }}</td>
              <td class="d-flex gap-2 flex-wrap">
                {% if r.customer == request.user or request.user.is_staff or request.user.is_superuser %}
                  <a href="{% url 'edit_repair' r.id %}" class="btn btn-sm btn-info" title="Edit">
                    <i class="bi bi-pencil-square"></i>
                  </a>
                {% endif %}
                {% if request.user.is_staff or request.user.is_superuser %}
                  <a href="{% url 'delete_repair' r.id %}" class="btn btn-sm btn-danger" title="Delete" onclick="return confirm('Are you sure?')">
                    <i class="bi bi-trash"></i>
                  </a>
                {% endif %}
                <a href="{% url 'generate_invoice' r.id %}" class="btn btn-sm btn-success" title="Invoice">
                  <i class="bi bi-receipt-cutoff"></i>
                </a>
              </td>
            </tr>
            {% empty %}
            <tr><td colspan="10" class="text-center text-muted">No repair requests found.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="mt-auto">
        <nav class="d-flex justify-content-end">
          <ul class="pagination mb-4">
            {% if repairs.has_previous %}
              <li class="page-item"><a class="page-link" href="?page=1&search={{ request.GET.search }}">« First</a></li>
              <li class="page-item"><a class="page-link" href="?page={{ repairs.previous_page_number }}&search={{ request.GET.search }}">‹ Previous</a></li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">« First</span></li>
              <li class="page-item disabled"><span class="page-link">‹ Previous</span></li>
            {% endif %}

            <li class="page-item disabled"><span class="page-link">Page {{ repairs.number }} of {{ repairs.paginator.num_pages }}</span></li>

            {% if repairs.has_next %}
              <li class="page-item"><a class="page-link" href="?page={{ repairs.next_page_number }}&search={{ request.GET.search }}">Next ›</a></li>
              <li class="page-item"><a class="page-link" href="?page={{ repairs.paginator.num_pages }}&search={{ request.GET.search }}">Last »</a></li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">Next ›</span></li>
              <li class="page-item disabled"><span class="page-link">Last »</span></li>
            {% endif %}
          </ul>
        </nav>
      </div>


</div>
{% include "repair/footer.html" %}
{% endblock %}
<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const toastElList = [].slice.call(document.querySelectorAll('.toast'))
    toastElList.map(function (toastEl) {
      new bootstrap.Toast(toastEl, { delay: 4000 }).show()
    })
  })
</script>

</body>
</html>
